name: Build Windows Installer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      sign_build:
        description: 'Sign the executable and installer'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  APP_VERSION: '0.1.0'

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for version info

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~\AppData\Local\pip\Cache
          ~\.cache\pypoetry
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e ".[gui,package]"

    - name: Generate application icons
      run: |
        python build\generate_icons.py
      continue-on-error: true

    - name: Build executable with PyInstaller
      run: |
        python -m PyInstaller antidetect-browser.spec --clean --noconfirm

    - name: Validate build
      run: |
        python build\validate_build.py

    - name: Install Inno Setup
      run: |
        choco install innosetup -y

    - name: Create installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" build\installer.iss

    - name: Sign executable and installer
      if: |
        github.event_name == 'push' &&
        startsWith(github.ref, 'refs/tags/v') &&
        (github.event.inputs.sign_build == 'true' || secrets.SIGNING_CERTIFICATE != '')
      shell: pwsh
      run: |
        # Decode certificate from secrets
        $certBytes = [Convert]::FromBase64String("${{ secrets.SIGNING_CERTIFICATE }}")
        $certPath = "$env:TEMP\cert.pfx"
        [IO.File]::WriteAllBytes($certPath, $certBytes)

        # Find signtool
        $signTool = (Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe" |
                    Sort-Object LastWriteTime -Descending |
                    Select-Object -First 1).FullName

        # Sign executable
        & $signTool sign /f "$certPath" /p "${{ secrets.SIGNING_PASSWORD }}" `
          /tr "http://timestamp.digicert.com" /td SHA256 /fd SHA256 `
          "dist\AntidetectBrowser\AntidetectBrowser.exe"

        # Sign installer
        & $signTool sign /f "$certPath" /p "${{ secrets.SIGNING_PASSWORD }}" `
          /tr "http://timestamp.digicert.com" /td SHA256 /fd SHA256 `
          "dist\AntidetectBrowser-Setup-${{ env.APP_VERSION }}.exe"

        # Clean up certificate
        Remove-Item $certPath
      continue-on-error: true

    - name: Create portable ZIP
      run: |
        Compress-Archive -Path dist\AntidetectBrowser -DestinationPath dist\AntidetectBrowser-Windows-x64-Portable.zip

    - name: Calculate checksums
      shell: pwsh
      run: |
        $files = Get-ChildItem dist\AntidetectBrowser-Setup-*.exe, dist\*Portable.zip
        foreach ($file in $files) {
          $hash = (Get-FileHash $file -Algorithm SHA256).Hash
          "$hash  $($file.Name)" | Out-File -Append checksums.txt
        }
        Get-Content checksums.txt

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          dist/AntidetectBrowser-Setup-*.exe
          checksums.txt
        retention-days: 30

    - name: Upload portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable
        path: dist/AntidetectBrowser-Windows-x64-Portable.zip
        retention-days: 30

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/**/*.log
          dist/**/*.log
        retention-days: 7

  test-installer:
    name: Test Windows Installer
    needs: build-windows
    runs-on: windows-latest

    steps:
    - name: Download installer
      uses: actions/download-artifact@v4
      with:
        name: windows-installer

    - name: Install application
      shell: pwsh
      run: |
        $installer = Get-ChildItem AntidetectBrowser-Setup-*.exe | Select-Object -First 1
        Write-Host "Installing: $($installer.Name)"

        # Silent install
        Start-Process -FilePath $installer.FullName -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/LOG=install.log" -Wait

    - name: Verify installation
      shell: pwsh
      run: |
        # Check if executable exists
        $exePath = "$env:ProgramFiles\Antidetect Browser\AntidetectBrowser.exe"
        if (-not (Test-Path $exePath)) {
          Write-Error "Executable not found at: $exePath"
          exit 1
        }

        Write-Host "✓ Executable found"

        # Check Start Menu shortcut
        $startMenuPath = "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Antidetect Browser"
        if (-not (Test-Path $startMenuPath)) {
          Write-Warning "Start Menu shortcut not found"
        } else {
          Write-Host "✓ Start Menu shortcut created"
        }

    - name: Test uninstaller
      shell: pwsh
      run: |
        $uninstaller = "$env:ProgramFiles\Antidetect Browser\unins000.exe"
        if (Test-Path $uninstaller) {
          Start-Process -FilePath $uninstaller -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          Write-Host "✓ Uninstaller completed"
        }

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          install.log
        retention-days: 7

  release:
    name: Create GitHub Release
    needs: [build-windows, test-installer]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: windows-*
        merge-multiple: true
        path: artifacts

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        cat > RELEASE_NOTES.md <<EOF
        # Antidetect Browser v${{ steps.get_version.outputs.VERSION }}

        ## Windows Installer

        **Installation:**
        1. Download \`AntidetectBrowser-Setup-${{ steps.get_version.outputs.VERSION }}.exe\`
        2. Run the installer (no admin rights required)
        3. Follow the installation wizard
        4. Launch from Start Menu or Desktop shortcut

        **Portable Version:**
        Download \`AntidetectBrowser-Windows-x64-Portable.zip\` and extract to any folder.

        ## Features
        - ✅ Modern Qt6-based GUI
        - ✅ Stealth browser automation with anti-detection
        - ✅ Profile management
        - ✅ Proxy support (HTTP, SOCKS5)
        - ✅ Fingerprint customization
        - ✅ Auto-update system

        ## System Requirements
        - Windows 10/11 (64-bit)
        - 4GB RAM (8GB recommended)
        - 500MB disk space

        ## Checksums (SHA256)
        \`\`\`
        $(cat artifacts/checksums.txt)
        \`\`\`

        ## Auto-Updates
        This version supports automatic updates. Enable in Settings to receive future updates.

        ---
        For issues and support, visit: https://github.com/antidetect/antidetect-playwright/issues
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release v${{ steps.get_version.outputs.VERSION }}
        body_path: RELEASE_NOTES.md
        files: |
          artifacts/AntidetectBrowser-Setup-*.exe
          artifacts/AntidetectBrowser-Windows-x64-Portable.zip
          artifacts/checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Build Status
    needs: [build-windows, test-installer]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Report success
      if: needs.build-windows.result == 'success' && needs.test-installer.result == 'success'
      run: |
        echo "✅ Windows build and tests completed successfully"

    - name: Report failure
      if: needs.build-windows.result == 'failure' || needs.test-installer.result == 'failure'
      run: |
        echo "❌ Windows build or tests failed"
        exit 1
