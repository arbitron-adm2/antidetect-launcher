name: Build Linux Packages

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts debhelper dh-python build-essential \
          python3-all python3-setuptools python3-wheel python3-pip \
          libqt6core6 libqt6gui6 libqt6widgets6 libqt6svg6

    - name: Build DEB package
      run: |
        chmod +x build/scripts/build_deb.sh
        ./build/scripts/build_deb.sh build

    - name: Run lintian
      run: |
        lintian build/debian/*.deb || true

    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-package
        path: build/debian/*.deb

  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget fuse libfuse2 python3-pip python3-venv

    - name: Build AppImage
      run: |
        chmod +x build/scripts/build_appimage.sh
        ./build/scripts/build_appimage.sh

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: appimage
        path: build/appimage/*.AppImage

  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Flatpak
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

    - name: Build source distribution
      run: |
        pip install build
        python3 -m build --sdist

    - name: Build Flatpak
      run: |
        chmod +x build/scripts/build_flatpak.sh
        ./build/scripts/build_flatpak.sh

    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak
        path: build/flatpak/*.flatpak

  test-deb-install:
    name: Test DEB Installation
    needs: build-deb
    runs-on: ubuntu-22.04

    steps:
    - name: Download DEB package
      uses: actions/download-artifact@v4
      with:
        name: deb-package

    - name: Install package
      run: |
        sudo dpkg -i *.deb || sudo apt-get install -f -y

    - name: Test executables
      run: |
        which antidetect-browser
        which antidetect-playwright
        antidetect-playwright --version || true

    - name: Test desktop file
      run: |
        test -f /usr/share/applications/antidetect-browser.desktop
        desktop-file-validate /usr/share/applications/antidetect-browser.desktop || true

    - name: Test icons
      run: |
        test -f /usr/share/icons/hicolor/128x128/apps/antidetect-browser.png

  release:
    name: Create Release
    needs: [build-deb, build-appimage, build-flatpak, test-deb-install]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          deb-package/*.deb
          appimage/*.AppImage
          flatpak/*.flatpak
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
