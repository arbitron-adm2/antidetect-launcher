#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export PYBUILD_NAME=antidetect-playwright
export PYBUILD_INSTALL_ARGS=--install-lib=/opt/antidetect-browser/lib \
                            --install-scripts=/opt/antidetect-browser/bin

# Python 3.12 minimum version
export PYBUILD_PYTHON_VERSION=3.12

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_install:
	dh_auto_install
	# Create virtual environment in /opt/antidetect-browser
	python3 -m venv debian/antidetect-browser/opt/antidetect-browser/venv
	# Install package and dependencies into venv
	debian/antidetect-browser/opt/antidetect-browser/venv/bin/pip install \
		--no-cache-dir --upgrade pip setuptools wheel
	debian/antidetect-browser/opt/antidetect-browser/venv/bin/pip install \
		--no-cache-dir -e .
	# Install GUI dependencies
	debian/antidetect-browser/opt/antidetect-browser/venv/bin/pip install \
		--no-cache-dir ".[gui]"
	# Install Playwright browsers
	debian/antidetect-browser/opt/antidetect-browser/venv/bin/playwright install chromium
	# Copy resources
	mkdir -p debian/antidetect-browser/opt/antidetect-browser/share
	cp -r src/antidetect_playwright/resources \
		debian/antidetect-browser/opt/antidetect-browser/share/
	# Copy icons
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/16x16/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/24x24/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/32x32/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/48x48/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/64x64/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/128x128/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/256x256/apps
	mkdir -p debian/antidetect-browser/usr/share/icons/hicolor/512x512/apps
	mkdir -p debian/antidetect-browser/usr/share/pixmaps
	cp build/icons/linux/icon_16x16.png \
		debian/antidetect-browser/usr/share/icons/hicolor/16x16/apps/antidetect-browser.png
	cp build/icons/linux/icon_24x24.png \
		debian/antidetect-browser/usr/share/icons/hicolor/24x24/apps/antidetect-browser.png
	cp build/icons/linux/icon_32x32.png \
		debian/antidetect-browser/usr/share/icons/hicolor/32x32/apps/antidetect-browser.png
	cp build/icons/linux/icon_48x48.png \
		debian/antidetect-browser/usr/share/icons/hicolor/48x48/apps/antidetect-browser.png
	cp build/icons/linux/icon_64x64.png \
		debian/antidetect-browser/usr/share/icons/hicolor/64x64/apps/antidetect-browser.png
	cp build/icons/linux/icon_128x128.png \
		debian/antidetect-browser/usr/share/icons/hicolor/128x128/apps/antidetect-browser.png
	cp build/icons/linux/icon_256x256.png \
		debian/antidetect-browser/usr/share/icons/hicolor/256x256/apps/antidetect-browser.png
	cp build/icons/linux/icon_512x512.png \
		debian/antidetect-browser/usr/share/icons/hicolor/512x512/apps/antidetect-browser.png
	cp build/icons/linux/icon_128x128.png \
		debian/antidetect-browser/usr/share/pixmaps/antidetect-browser.png
	# Install desktop file
	mkdir -p debian/antidetect-browser/usr/share/applications
	cp build/linux/antidetect-browser.desktop \
		debian/antidetect-browser/usr/share/applications/
	# Create wrapper script
	mkdir -p debian/antidetect-browser/usr/bin
	echo '#!/bin/bash' > debian/antidetect-browser/usr/bin/antidetect-browser
	echo 'exec /opt/antidetect-browser/venv/bin/python3 -m antidetect_playwright.gui.app "$$@"' \
		>> debian/antidetect-browser/usr/bin/antidetect-browser
	chmod +x debian/antidetect-browser/usr/bin/antidetect-browser
	# Create CLI wrapper
	echo '#!/bin/bash' > debian/antidetect-browser/usr/bin/antidetect-playwright
	echo 'exec /opt/antidetect-browser/venv/bin/python3 -m antidetect_playwright "$$@"' \
		>> debian/antidetect-browser/usr/bin/antidetect-playwright
	chmod +x debian/antidetect-browser/usr/bin/antidetect-playwright

override_dh_installdocs:
	dh_installdocs
	# Copy documentation
	mkdir -p debian/antidetect-browser/opt/antidetect-browser/doc
	[ -f README.md ] && cp README.md debian/antidetect-browser/opt/antidetect-browser/doc/ || true
	[ -f LICENSE ] && cp LICENSE debian/antidetect-browser/opt/antidetect-browser/doc/ || true

override_dh_compress:
	dh_compress -X.md -X.txt

override_dh_strip:
	# Don't strip Python bytecode
	dh_strip --exclude=.pyc --exclude=.pyo

override_dh_shlibdeps:
	# Skip automatic shared library dependencies for bundled libs
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info
